name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      - name: Install Node deps
        run: npm ci
      - name: JS Lint & Format
        run: |
          npm run format -- --check || true
          npm run lint || true
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install Python deps
        run: pip3 install -r requirements.txt
      - name: Python Lint
        run: |
          flake8 || true
          mypy || true
      - name: Run tests
        run: npm test || true

  rust-bench:
    runs-on: ubuntu-latest
    needs: build-and-lint
    steps:
      - uses: actions/checkout@v4
      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
      - name: Run Rust Bench
        run: cd matching-engine && cargo bench || true

  security-scan:
    runs-on: ubuntu-latest
    needs: build-and-lint
    steps:
      - uses: actions/checkout@v4
      - name: Run Snyk (SCA)
        uses: snyk/actions/node@v1
        with:
          args: test
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      - name: Generate SBOM with Syft
        uses: anchore/syft-action@v0.10.0
        with:
          image: .
      - name: Scan container images with Trivy
        uses: aquasecurity/trivy-action@v1
        with:
          scan-type: fs
          format: table

  image-signing:
    runs-on: ubuntu-latest
    needs: security-scan
    steps:
      - uses: actions/checkout@v4
      - name: Setup cosign
        uses: sigstore/cosign-installer@v2
      - name: Sign docker image
        env:
          COSIGN_KEY: ${{ secrets.COSIGN_KEY }}
          DOCKER_IMAGE: ${{ secrets.DOCKER_IMAGE }}
        run: |
          if [[ -z "${DOCKER_IMAGE:-}" ]]; then
            echo "DOCKER_IMAGE not set; skipping image signing.";
          else
            ./scripts/sign-image.sh "${DOCKER_IMAGE}"
          fi
